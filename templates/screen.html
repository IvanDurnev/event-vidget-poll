<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–≠–∫—Ä–∞–Ω –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }
        body {
            font-family: Arial;
            margin: 0;
            height: 100vh;
            display: flex;
            background: none;
        }
        #center {
            flex: 2;
            padding: 30px;
        }
        #question {
            font-size: 32px;
            margin-bottom: 30px;
            text-align: center;
        }
        #chat {
            display: flex;
            flex: 0.5;
            flex-direction: column;
            gap: 6px;
        }

        #empty {
            font-size: 32px;
            text-align: center;
            margin-top: 40vh;
        }
        .msg {
            display: inline-block;
            align-self: flex-start;

            max-width: 80%;
            padding: 12px 16px;

            background: #f1f1f1;
            color: #1f2d3d;

            border-radius: 18px;
            font-size: 24px;
            line-height: 1.35;

            word-wrap: break-word;
            position: relative;
            animation: pop 0.15s ease-out;
        }
        .msg::after {
            content: "";
            position: absolute;
            left: -6px;
            bottom: 10px;

            width: 0;
            height: 0;

            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
            border-right: 6px solid #f1f1f1;
            transform: rotate(-20deg) translate(10%, 40%);
        }

        @keyframes pop {
            from {
                transform: scale(0.95);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }
    </style>
</head>
<body>

<div id="center">
    <h1 id="question" style="display:none"></h1>

    <div id="empty">–û–∂–∏–¥–∞–Ω–∏–µ –Ω–∞—á–∞–ª–∞ –æ–ø—Ä–æ—Å–∞‚Ä¶</div>
    <canvas id="chart" style="display:none"></canvas>
</div>

<div id="chat">
    <h2>–ß–∞—Ç</h2>
</div>

<script>
    let currentPollId = null;
    let chart = null;
    let evtSource = null;

    const questionEl = document.getElementById("question");
    const empty = document.getElementById("empty");
    const canvas = document.getElementById("chart");
    const chat = document.getElementById("chat");
    const BAR_COLORS = [
        "#4e79a7", // —Å–∏–Ω–∏–π
        "#59a14f", // –∑–µ–ª—ë–Ω—ã–π
        "#f28e2b", // –æ—Ä–∞–Ω–∂–µ–≤—ã–π
        "#e15759", // –∫—Ä–∞—Å–Ω—ã–π
        "#76b7b2", // –±–∏—Ä—é–∑–æ–≤—ã–π
        "#edc949", // –∂—ë–ª—Ç—ã–π
        "#af7aa1", // —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π
        "#ff9da7", // —Ä–æ–∑–æ–≤—ã–π
        "#9c755f", // –∫–æ—Ä–∏—á–Ω–µ–≤—ã–π
        "#bab0ab"  // —Å–µ—Ä—ã–π
    ];


    function initChart() {
        const ctx = canvas.getContext("2d");
        chart = new Chart(ctx, {
            type: "bar",
            data: {
                labels: [],
                datasets: [{
                    data: [],
                    backgroundColor: "#4e79a7"
                }]
            },
            options: {
                plugins: {
                    legend: {
                        display: false
                    },
                    datalabels: false // –µ—Å–ª–∏ –≤–¥—Ä—É–≥ –ø–æ–¥–∫–ª—é—á–µ–Ω chartjs-plugin-datalabels
                },
                scales: {
                    x: {
                        display: true,
                        grid: {
                            display: false
                        },
                        border: {
                            display: false
                        },
                        ticks: {
                            font: {
                                size: 24,
                                weight: 'bold'
                            },
                            // color: '#fff',
                            padding: 10
                        }
                    },
                    y: {
                        display: false,
                        beginAtZero: true,
                        grid: { display: false },
                        ticks: {
                            display: false // —Ü–∏—Ñ—Ä—ã —Å–ª–µ–≤–∞ –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω—ã
                        }
                    }
                }
            },
            plugins: [{
                id: 'barValues',
                afterDatasetsDraw(chart) {
                    const { ctx } = chart;

                    chart.data.datasets.forEach((dataset, i) => {
                        const meta = chart.getDatasetMeta(i);

                        meta.data.forEach((bar, index) => {
                            const value = dataset.data[index];
                            if (value === 0) return;

                            ctx.save();
                            ctx.fillStyle = '#fff';
                            ctx.font = 'bold 42px Arial';
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'middle';

                            ctx.fillText(
                                value,
                                bar.x,
                                bar.y + bar.height / 2
                            );

                            ctx.restore();
                        });
                    });
                }
            }]
        });
    }

    function connectSSE() {
        if (evtSource) evtSource.close();
        evtSource = new EventSource("/screen/stream");

        evtSource.onmessage = e => {
            const data = JSON.parse(e.data);

            const div = document.createElement("div");
            div.className = "msg";
            div.textContent = data.text;

            const firstMsg = chat.querySelector(".msg");

            if (firstMsg) {
                chat.insertBefore(div, firstMsg); // üëà –ø–µ—Ä–µ–¥ –ø–µ—Ä–≤—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
            } else {
                chat.appendChild(div); // –µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –µ—â—ë –Ω–µ—Ç
            }
        };
    }


    function updateChart() {
        fetch("/screen/stats")
            .then(r => r.json())
            .then(data => {
                chart.data.labels = data.map(o => o.label);
                chart.data.datasets[0].data = data.map(o => o.count);

                const max = Math.max(...data);
                chart.data.datasets[0].backgroundColor = data.map((v, i) => v === max ? "#2f5597" : BAR_COLORS[i % BAR_COLORS.length]);

                chart.update();
            });
    }

    function loadChatHistory() {
        chat.innerHTML = "<h2>–ß–∞—Ç</h2>";

        fetch("/screen/chat")
            .then(r => r.json())
            .then(messages => {
                messages
                    .slice()        // —á—Ç–æ–±—ã –Ω–µ –º—É—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª
                    .reverse()      // –Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É
                    .forEach(text => {
                        const div = document.createElement("div");
                        div.className = "msg";
                        div.textContent = text;
                        chat.appendChild(div);
                    });

                chat.scrollTop = 0;
            });
    }


    function checkState() {
        fetch("/screen/state")
            .then(r => r.json())
            .then(state => {
                if (!state.active) {
                    currentPollId = null;

                    questionEl.style.display = "none";
                    empty.style.display = "block";
                    canvas.style.display = "none";

                    chat.innerHTML = "<h2>–ß–∞—Ç</h2>";

                    if (evtSource) {
                        evtSource.close();
                        evtSource = null;
                    }

                    return;
                }

                if (state.poll_id !== currentPollId) {
                    // –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –ù–û–í–´–ô –æ–ø—Ä–æ—Å
                    currentPollId = state.poll_id;

                    questionEl.textContent = state.question;
                    questionEl.style.display = "block";

                    empty.style.display = "none";
                    canvas.style.display = "block";
                    chat.innerHTML = "<h2>–ß–∞—Ç</h2>";

                    if (!chart) initChart();

                    loadChatHistory();
                    connectSSE();
                }
            });
    }

    setInterval(checkState, 1000);
    setInterval(() => {
        if (currentPollId && chart) updateChart();
    }, 1000);
</script>

</body>
</html>